# syntax=docker/dockerfile:1
FROM ros:jazzy

# Update default packages
RUN apt-get update

# Get Ubuntu packages
RUN apt-get install -y \
    build-essential \
    curl \
    libclang-dev \
    git \
    python3-pip \
    python3-vcstool

# Get Rust
RUN curl --proto '=https' --tlsv1.2 https://sh.rustup.rs -sSf | bash -s -- -y
RUN echo 'source $HOME/.cargo/env' >> $HOME/.bashrc
RUN . $HOME/.cargo/env && cargo install --debug cargo-ament-build
# Install colcon-cargo and colcon-ros-cargo in a way that works with system-managed python
RUN pip install --break-system-packages git+https://github.com/colcon/colcon-cargo.git
RUN pip install --break-system-packages git+https://github.com/colcon/colcon-ros-cargo.git

WORKDIR /ros2_rust_build
RUN git clone https://github.com/ros2-rust/ros2_rust.git src/ros2_rust
RUN vcs import src < src/ros2_rust/ros2_rust_jazzy.repos

# Copy the local repository into the colcon workspace so ros_integration_tests can find it
# Copy the local repository into the colcon workspace in two locations so the tests and the package
# dependency can both find the sources regardless of relative paths
# Copy the local repository into the colcon workspace so packages can depend on it
RUN mkdir -p /ros2_rust_build/src/ros_pointcloud2
COPY . /ros2_rust_build/src/ros_pointcloud2

# Copy the test-node crate into the image (outside the colcon src workspace so colcon doesn't try to build it)
RUN mkdir -p /ros2_rust_build/ros_pointcloud2_tests
COPY ros_pointcloud2_tests /ros2_rust_build/ros_pointcloud2_tests

WORKDIR /ros2_rust_build
# Remove a nested copy of the test crate that may have been copied into the repo root to avoid duplicate
# package names for colcon. We'll ensure the repo's internal copy doesn't collide with the test artifact.
RUN rm -rf /ros2_rust_build/src/ros_pointcloud2/ros_pointcloud2_tests || true
# Also remove the workspace's own `ros_integration_tests` that expects a different layout to avoid build failures
RUN rm -rf /ros2_rust_build/src/ros_pointcloud2/ros_integration_tests || true

# Attempt to build the ROS workspace (best-effort). Some upstream example packages may fail in this environment
# and are not required for our test; continue even if colcon reports failures to allow the test node to run.
RUN . $HOME/.cargo/env && . /opt/ros/jazzy/setup.sh && (colcon build --event-handlers console_direct+ --cmake-args -DCMAKE_BUILD_TYPE=Release --packages-skip ros_pointcloud2_tests --packages-skip ros_integration_tests || true)

RUN chmod +x /ros2_rust_build/ros_pointcloud2_tests/tests/rclrs_test.bash
ENTRYPOINT [ "/ros2_rust_build/ros_pointcloud2_tests/tests/rclrs_test.bash" ]
CMD [ "derive,nalgebra,rayon,serde,rclrs" ]
